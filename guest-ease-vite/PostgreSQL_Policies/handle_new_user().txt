-- Optional: table to log trigger errors
create table if not exists profile_trigger_errors (
    id serial primary key,
    user_id uuid,
    error_message text,
    created_at timestamptz default now()
);

-- Trigger function
create or replace function handle_new_user()
returns trigger as $$
begin
    begin
        insert into profiles (id, email, role, created_at)
        values (
            new.id,
            new.email,
            coalesce(new.raw_user_meta_data->>'role', 'guest'),
            now()
        )
        on conflict (id) do nothing;
    exception when others then
        -- Log the error without failing signup
        insert into profile_trigger_errors(user_id, error_message)
        values (new.id, sqlerrm);
    end;

    return new;
end;
$$ language plpgsql security definer;


-- Drop old trigger if exists
drop trigger if exists on_auth_user_created on auth.users;

-- Create new trigger
create trigger on_auth_user_created
after insert on auth.users
for each row
execute procedure handle_new_user();


insert into profiles (id, email, role, created_at)
select
    id,
    email,
    coalesce(raw_user_meta_data->>'role', 'guest'),
    now()
from auth.users
where id not in (select id from profiles);
