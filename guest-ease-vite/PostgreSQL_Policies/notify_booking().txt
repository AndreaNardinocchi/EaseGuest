CREATE OR REPLACE FUNCTION notify_booking()
RETURNS trigger AS $$
DECLARE
    user_email text;
BEGIN
    -- Get user's email
    SELECT email INTO user_email
    FROM auth.users
    WHERE id = NEW.user_id;

    IF user_email IS NULL THEN
        PERFORM pg_notify('notify_booking_error', 'No email found for user_id=' || NEW.user_id);
        RETURN NEW;
    END IF;

    -- -- Insert email into queue
    -- INSERT INTO public.mail_queue(recipient, subject, body)
    -- VALUES (
    --     user_email,
    --     'Your Booking Confirmation',
    --     format(
    --         'Your booking is confirmed! Check-in: %s, Check-out: %s, Guests: %s',
    --         NEW.check_in,
    --         NEW.check_out,
    --         NEW.guests
    --     )
    -- );

    INSERT INTO public.mail_queue(recipient, subject, body)
VALUES (
    user_email,
    'Your Booking Confirmation',
    json_build_object(
        'room_id', NEW.room_id,
        'check_in', NEW.check_in,
        'check_out', NEW.check_out,
        'guests', NEW.guests
    )::text
);


    PERFORM pg_notify('notify_booking_info', 'Booking queued for user_id=' || NEW.user_id);

    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Drop old trigger if exists
DROP TRIGGER IF EXISTS trigger_notify_booking ON public.bookings;

-- Create trigger
CREATE TRIGGER trigger_notify_booking
AFTER INSERT ON public.bookings
FOR EACH ROW
EXECUTE FUNCTION notify_booking();


-- create or replace function notify_booking()
-- returns trigger as $$
-- declare
--     user_email text;
-- begin
--     -- Get user's email
--     select email into user_email
--     from auth.users
--     where id = NEW.user_id;

--     if user_email