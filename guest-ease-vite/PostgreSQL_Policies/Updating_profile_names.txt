-- Updating the profiles table names

-- UPDATE public.profiles p
-- SET 
--     first_name = u.raw_user_meta_data->>'first_name',
--     last_name  = u.raw_user_meta_data->>'last_name',
--     country = u.raw_user_meta_data->>'country',
--     zip_code  = u.raw_user_meta_data->>'zip_code'
-- FROM auth.users u
-- WHERE p.id = u.id
--   AND (p.first_name IS NULL OR p.last_name IS NULL OR p.country IS NULL OR p.zip_code IS NULL);

-- -- Update profiles table from auth.users metadata
-- UPDATE public.profiles AS p
-- SET 
--     first_name = u.raw_user_meta_data->>'first_name',
--     last_name  = u.raw_user_meta_data->>'last_name',
--     country    = u.raw_user_meta_data->>'country',
--     zip_code   = u.raw_user_meta_data->>'zip_code'
-- FROM auth.users AS u
-- WHERE p.id = u.id;

-- 1. Insert missing users into profiles
INSERT INTO public.profiles (id, email, role, created_at)
SELECT u.id, u.email, 'user', now()
FROM auth.users u
LEFT JOIN public.profiles p ON p.id = u.id
WHERE p.id IS NULL;

-- 2. Update profiles with metadata from auth.users
UPDATE public.profiles AS p
SET 
    first_name = u.raw_user_meta_data->>'first_name',
    last_name  = u.raw_user_meta_data->>'last_name',
    country    = u.raw_user_meta_data->>'country',
    zip_code   = u.raw_user_meta_data->>'zip_code'
FROM auth.users AS u
WHERE p.id = u.id;

